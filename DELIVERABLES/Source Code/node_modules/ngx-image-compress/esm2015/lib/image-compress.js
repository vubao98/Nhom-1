/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/** @enum {number} */
const DOC_ORIENTATION = {
    Up: 1,
    Down: 3,
    Right: 6,
    Left: 8,
    UpMirrored: 2,
    DownMirrored: 4,
    LeftMirrored: 5,
    RightMirrored: 7,
    NotJpeg: -1,
    NotDefined: -2,
};
export { DOC_ORIENTATION };
DOC_ORIENTATION[DOC_ORIENTATION.Up] = 'Up';
DOC_ORIENTATION[DOC_ORIENTATION.Down] = 'Down';
DOC_ORIENTATION[DOC_ORIENTATION.Right] = 'Right';
DOC_ORIENTATION[DOC_ORIENTATION.Left] = 'Left';
DOC_ORIENTATION[DOC_ORIENTATION.UpMirrored] = 'UpMirrored';
DOC_ORIENTATION[DOC_ORIENTATION.DownMirrored] = 'DownMirrored';
DOC_ORIENTATION[DOC_ORIENTATION.LeftMirrored] = 'LeftMirrored';
DOC_ORIENTATION[DOC_ORIENTATION.RightMirrored] = 'RightMirrored';
DOC_ORIENTATION[DOC_ORIENTATION.NotJpeg] = 'NotJpeg';
DOC_ORIENTATION[DOC_ORIENTATION.NotDefined] = 'NotDefined';
export class ImageCompress {
    /**
     * Get the correct Orientation value from tags, in order to write correctly in our canvas
     * @param {?} file
     * @param {?} callback
     * @return {?}
     */
    static getOrientation(file, callback) {
        /** @type {?} */
        const reader = new FileReader();
        try {
            reader.onload = (/**
             * @param {?} $event
             * @return {?}
             */
            function ($event) {
                /** @type {?} */
                const view = new DataView((/** @type {?} */ (reader.result)));
                if (view.getUint16(0, false) !== 0xFFD8) {
                    return callback(-2);
                }
                /** @type {?} */
                const length = view.byteLength;
                /** @type {?} */
                let offset = 2;
                while (offset < length) {
                    /** @type {?} */
                    const marker = view.getUint16(offset, false);
                    offset += 2;
                    if (marker === 0xFFE1) {
                        if (view.getUint32(offset += 2, false) !== 0x45786966) {
                            return callback(-1);
                        }
                        /** @type {?} */
                        const little = view.getUint16(offset += 6, false) === 0x4949;
                        offset += view.getUint32(offset + 4, little);
                        /** @type {?} */
                        const tags = view.getUint16(offset, little);
                        offset += 2;
                        for (let i = 0; i < tags; i++) {
                            if (view.getUint16(offset + (i * 12), little) === 0x0112) {
                                return callback(view.getUint16(offset + (i * 12) + 8, little));
                            }
                        }
                    }
                    else if ((marker & 0xFF00) !== 0xFF00) {
                        break;
                    }
                    else {
                        offset += view.getUint16(offset, false);
                    }
                }
                return callback(-1);
            });
            reader.readAsArrayBuffer(file);
        }
        catch (e) {
            return callback(0);
        }
    }
    /**
     * return a promise with the new image data and image orientation
     * @param {?} render
     * @return {?}
     */
    static uploadFile(render) {
        /** @type {?} */
        const promise = new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        function (resolve, reject) {
            /** @type {?} */
            const inputElement = render.createElement('input');
            render.setStyle(inputElement, 'display', 'none');
            render.setProperty(inputElement, 'type', 'file');
            render.listen(inputElement, 'click', (/**
             * @param {?} $event
             * @return {?}
             */
            ($event) => {
                //console.log('MouseEvent:', $event);
                //console.log('Input:', $event.target);
                $event.target.value = null;
            }));
            render.listen(inputElement, 'change', (/**
             * @param {?} $event
             * @return {?}
             */
            ($event) => {
                /** @type {?} */
                const file = $event.target.files[0];
                /** @type {?} */
                const myReader = new FileReader();
                myReader.onloadend = (/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    try {
                        ImageCompress.getOrientation(file, (/**
                         * @param {?} orientation
                         * @return {?}
                         */
                        orientation => {
                            resolve({ image: (/** @type {?} */ (myReader.result)), orientation });
                        }));
                    }
                    catch (e) {
                        //console.log(`ngx-image-compress error ${e}`);
                        reject(e);
                    }
                });
                try {
                    myReader.readAsDataURL(file);
                }
                catch (e) {
                    console.warn(`ngx-image-compress - probably no file have been selected: ${e}`);
                    reject("No file selected");
                }
            }));
            inputElement.click();
        }));
        return promise;
    }
    /**
     * @param {?} imageDataUrlSource
     * @param {?} orientation
     * @param {?} render
     * @param {?=} ratio
     * @param {?=} quality
     * @return {?}
     */
    static compress(imageDataUrlSource, orientation, render, ratio = 50, quality = 50) {
        /** @type {?} */
        const promise = new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        function (resolve, reject) {
            quality = quality / 100;
            ratio = ratio / 100;
            /** @type {?} */
            const sourceImage = new Image();
            // important for safari: we need to wait for onload event
            sourceImage.onload = (/**
             * @return {?}
             */
            function () {
                /** @type {?} */
                const canvas = render.createElement('canvas');
                /** @type {?} */
                const ctx = canvas.getContext('2d');
                /** @type {?} */
                let w;
                /** @type {?} */
                let h;
                w = sourceImage.naturalWidth;
                h = sourceImage.naturalHeight;
                if (orientation === DOC_ORIENTATION.Right || orientation === DOC_ORIENTATION.Left) {
                    /** @type {?} */
                    const t = w;
                    w = h;
                    h = t;
                }
                canvas.width = w * ratio;
                canvas.height = h * ratio;
                /** @type {?} */
                const TO_RADIANS = Math.PI / 180;
                if (orientation === DOC_ORIENTATION.Up) {
                    ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
                }
                else if (orientation === DOC_ORIENTATION.Right) {
                    ctx.save();
                    ctx.rotate(90 * TO_RADIANS);
                    ctx.translate(0, -canvas.width);
                    ctx.drawImage(sourceImage, 0, 0, canvas.height, canvas.width);
                    ctx.restore();
                }
                else if (orientation === DOC_ORIENTATION.Left) {
                    ctx.save();
                    ctx.rotate(-90 * TO_RADIANS);
                    ctx.translate(-canvas.width, 0);
                    ctx.drawImage(sourceImage, 0, 0, canvas.height, canvas.width);
                    ctx.restore();
                }
                else if (orientation === DOC_ORIENTATION.Down) {
                    ctx.save();
                    ctx.rotate(180 * TO_RADIANS);
                    ctx.translate(-canvas.width, -canvas.height);
                    ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
                    ctx.restore();
                }
                else {
                    console.warn('ngx-image-compress - no orientation value found');
                    // same as default UP
                    ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
                }
                /** @type {?} */
                const mime = imageDataUrlSource.substr(5, imageDataUrlSource.split(';')[0].length - 5);
                // TODO test on mime
                /** @type {?} */
                const result = canvas.toDataURL(mime, quality);
                resolve(result);
            });
            sourceImage.src = imageDataUrlSource;
        }));
        return promise;
    }
    /**
     * helper to evaluate the compression rate
     * @param {?} s the image in base64 string format
     * @return {?}
     */
    static byteCount(s) {
        return encodeURI(s).split(/%..|./).length - 1;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UtY29tcHJlc3MuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtaW1hZ2UtY29tcHJlc3MvIiwic291cmNlcyI6WyJsaWIvaW1hZ2UtY29tcHJlc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0lBR0UsS0FBTTtJQUNOLE9BQVE7SUFDUixRQUFTO0lBQ1QsT0FBUTtJQUNSLGFBQWM7SUFDZCxlQUFnQjtJQUNoQixlQUFnQjtJQUNoQixnQkFBaUI7SUFDakIsV0FBWTtJQUNaLGNBQWU7Ozs7Ozs7Ozs7Ozs7QUFJakIsTUFBTSxPQUFPLGFBQWE7Ozs7Ozs7SUFNeEIsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFVLEVBQUUsUUFBMkM7O2NBQ3JFLE1BQU0sR0FBRyxJQUFJLFVBQVUsRUFBRTtRQUMvQixJQUFJO1lBQ0YsTUFBTSxDQUFDLE1BQU07Ozs7WUFBRyxVQUFVLE1BQU07O3NCQUN4QixJQUFJLEdBQUcsSUFBSSxRQUFRLENBQUMsbUJBQUEsTUFBTSxDQUFDLE1BQU0sRUFBZSxDQUFDO2dCQUN2RCxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxLQUFLLE1BQU0sRUFBRTtvQkFBRSxPQUFPLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUFFOztzQkFDM0QsTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVOztvQkFDMUIsTUFBTSxHQUFHLENBQUM7Z0JBQ2QsT0FBTyxNQUFNLEdBQUcsTUFBTSxFQUFFOzswQkFDaEIsTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQztvQkFDNUMsTUFBTSxJQUFJLENBQUMsQ0FBQztvQkFDWixJQUFJLE1BQU0sS0FBSyxNQUFNLEVBQUU7d0JBQ3JCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFLEtBQUssQ0FBQyxLQUFLLFVBQVUsRUFBRTs0QkFBRSxPQUFPLFFBQVEsQ0FBQyxDQUFDLENB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Ozs7O0lBT0QsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFTO1FBQ3hCLE9BQU8sU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ2hELENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7UmVuZGVyZXIyfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuZXhwb3J0IGVudW0gRE9DX09SSUVOVEFUSU9OIHtcbiAgVXAgPSAxLFxuICBEb3duID0gMyxcbiAgUmlnaHQgPSA2LFxuICBMZWZ0ID0gOCxcbiAgVXBNaXJyb3JlZCA9IDIsXG4gIERvd25NaXJyb3JlZCA9IDQsXG4gIExlZnRNaXJyb3JlZCA9IDUsXG4gIFJpZ2h0TWlycm9yZWQgPSA3LFxuICBOb3RKcGVnID0gLTEsXG4gIE5vdERlZmluZWQgPSAtMlxufVxuXG5cbmV4cG9ydCBjbGFzcyBJbWFnZUNvbXByZXNzIHtcblxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGNvcnJlY3QgT3JpZW50YXRpb24gdmFsdWUgZnJvbSB0YWdzLCBpbiBvcmRlciB0byB3cml0ZSBjb3JyZWN0bHkgaW4gb3VyIGNhbnZhc1xuICAgKi9cbiAgc3RhdGljIGdldE9yaWVudGF0aW9uKGZpbGU6IEZpbGUsIGNhbGxiYWNrOiAocmVzdWx0OiBET0NfT1JJRU5UQVRJT04pID0+IHZvaWQpIHtcbiAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgIHRyeSB7XG4gICAgICByZWFkZXIub25sb2FkID0gZnVuY3Rpb24gKCRldmVudCkge1xuICAgICAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KHJlYWRlci5yZXN1bHQgYXMgQXJyYXlCdWZmZXIpO1xuICAgICAgICBpZiAodmlldy5nZXRVaW50MTYoMCwgZmFsc2UpICE9PSAweEZGRDgpIHsgcmV0dXJuIGNhbGxiYWNrKC0yKTsgfVxuICAgICAgICBjb25zdCBsZW5ndGggPSB2aWV3LmJ5dGVMZW5ndGg7XG4gICAgICAgIGxldCBvZmZzZXQgPSAyO1xuICAgICAgICB3aGlsZSAob2Zmc2V0IDwgbGVuZ3RoKSB7XG4gICAgICAgICAgY29uc3QgbWFya2VyID0gdmlldy5nZXRVaW50MTYob2Zmc2V0LCBmYWxzZSk7XG4gICAgICAgICAgb2Zmc2V0ICs9IDI7XG4gICAgICAgICAgaWYgKG1hcmtlciA9PT0gMHhGRkUxKSB7XG4gICAgICAgICAgICBpZiAodmlldy5nZXRVaW50MzIob2Zmc2V0ICs9IDIsIGZhbHNlKSAhPT0gMHg0NTc4Njk2NikgeyByZXR1cm4gY2FsbGJhY2soLTEpOyB9XG4gICAgICAgICAgICBjb25zdCBsaXR0bGUgPSB2aWV3LmdldFVpbnQxNihvZmZzZXQgKz0gNiwgZmFsc2UpID09PSAweDQ5NDk7XG4gICAgICAgICAgICBvZmZzZXQgKz0gdmlldy5nZXRVaW50MzIob2Zmc2V0ICsgNCwgbGl0dGxlKTtcbiAgICAgICAgICAgIGNvbnN0IHRhZ3MgPSB2aWV3LmdldFVpbnQxNihvZmZzZXQsIGxpdHRsZSk7XG4gICAgICAgICAgICBvZmZzZXQgKz0gMjtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFnczsgaSsrKSB7XG4gICAgICAgICAgICAgIGlmICh2aWV3LmdldFVpbnQxNihvZmZzZXQgKyAoaSAqIDEyKSwgbGl0dGxlKSA9PT0gMHgwMTEyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHZpZXcuZ2V0VWludDE2KG9mZnNldCArIChpICogMTIpICsgOCwgbGl0dGxlKSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2UgaWYgKChtYXJrZXIgJiAweEZGMDApICE9PSAweEZGMDApIHsgYnJlYWs7IH0gZWxzZSB7IG9mZnNldCArPSB2aWV3LmdldFVpbnQxNihvZmZzZXQsIGZhbHNlKTsgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjYWxsYmFjaygtMSk7XG4gICAgICB9O1xuICAgICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKGZpbGUpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiBjYWxsYmFjaygwKTtcbiAgICB9XG5cbiAgfVxuXG5cbiAgLyoqXG4gICAqIHJldHVybiBhIHByb21pc2Ugd2l0aCB0aGUgbmV3IGltYWdlIGRhdGEgYW5kIGltYWdlIG9yaWVudGF0aW9uXG4gICAqL1xuICBzdGF0aWMgdXBsb2FkRmlsZShyZW5kZXI6IFJlbmRlcmVyMik6UHJvbWlzZTx7aW1hZ2U6IHN0cmluZywgb3JpZW50YXRpb246IERPQ19PUklFTlRBVElPTn0+IHtcblxuICAgIGNvbnN0IHByb21pc2U6IFByb21pc2U8e2ltYWdlOiBzdHJpbmcsIG9yaWVudGF0aW9uOiBET0NfT1JJRU5UQVRJT059PiA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuXG4gICAgICBjb25zdCBpbnB1dEVsZW1lbnQgPSByZW5kZXIuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTtcbiAgICAgIHJlbmRlci5zZXRTdHlsZShpbnB1dEVsZW1lbnQsICdkaXNwbGF5JywgJ25vbmUnKTtcbiAgICAgIHJlbmRlci5zZXRQcm9wZXJ0eShpbnB1dEVsZW1lbnQsICd0eXBlJywgJ2ZpbGUnKTtcblxuICAgICAgcmVuZGVyLmxpc3RlbihpbnB1dEVsZW1lbnQsICdjbGljaycsICgkZXZlbnQpID0+IHtcbiAgICAgICAgLy9jb25zb2xlLmxvZygnTW91c2VFdmVudDonLCAkZXZlbnQpO1xuICAgICAgICAvL2NvbnNvbGUubG9nKCdJbnB1dDonLCAkZXZlbnQudGFyZ2V0KTtcbiAgICAgICAgJGV2ZW50LnRhcmdldC52YWx1ZSA9IG51bGw7XG4gICAgICB9KTtcblxuXG4gICAgICByZW5kZXIubGlzdGVuKGlucHV0RWxlbWVudCwgJ2NoYW5nZScsICgkZXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgZmlsZTogRmlsZSA9ICRldmVudC50YXJnZXQuZmlsZXNbMF07XG5cbiAgICAgICAgY29uc3QgbXlSZWFkZXI6IEZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuXG4gICAgICAgIG15UmVhZGVyLm9ubG9hZGVuZCA9IChlKSA9PiB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIEltYWdlQ29tcHJlc3MuZ2V0T3JpZW50YXRpb24oZmlsZSwgb3JpZW50YXRpb24gPT4ge1xuICAgICAgICAgICAgICByZXNvbHZlKHtpbWFnZTpteVJlYWRlci5yZXN1bHQgYXMgc3RyaW5nLCBvcmllbnRhdGlvbn0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhgbmd4LWltYWdlLWNvbXByZXNzIGVycm9yICR7ZX1gKTtcbiAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBteVJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKGBuZ3gtaW1hZ2UtY29tcHJlc3MgLSBwcm9iYWJseSBubyBmaWxlIGhhdmUgYmVlbiBzZWxlY3RlZDogJHtlfWApO1xuICAgICAgICAgIHJlamVjdChcIk5vIGZpbGUgc2VsZWN0ZWRcIik7XG4gICAgICAgIH1cblxuICAgICAgfSk7XG4gICAgICBpbnB1dEVsZW1lbnQuY2xpY2soKTtcblxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHByb21pc2U7XG4gIH1cblxuXG4gIHN0YXRpYyBjb21wcmVzcyhpbWFnZURhdGFVcmxTb3VyY2U6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgIG9yaWVudGF0aW9uOiBET0NfT1JJRU5UQVRJT04sXG4gICAgICAgICAgICAgICAgICByZW5kZXI6IFJlbmRlcmVyMixcbiAgICAgICAgICAgICAgICAgIHJhdGlvOiBudW1iZXIgPSA1MCxcbiAgICAgICAgICAgICAgICAgIHF1YWxpdHk6IG51bWJlciA9IDUwKTogUHJvbWlzZTxzdHJpbmc+IHtcblxuICAgIGNvbnN0IHByb21pc2U6IFByb21pc2U8c3RyaW5nPiA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuXG4gICAgICBxdWFsaXR5ID0gcXVhbGl0eSAvIDEwMDtcbiAgICAgIHJhdGlvID0gcmF0aW8gLyAxMDA7XG4gICAgICBjb25zdCBzb3VyY2VJbWFnZSA9IG5ldyBJbWFnZSgpO1xuXG4gICAgICAvLyBpbXBvcnRhbnQgZm9yIHNhZmFyaTogd2UgbmVlZCB0byB3YWl0IGZvciBvbmxvYWQgZXZlbnRcbiAgICAgIHNvdXJjZUltYWdlLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCA9IHJlbmRlci5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgICAgY29uc3QgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQgPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcblxuICAgICAgICBsZXQgdywgaDtcbiAgICAgICAgdyA9IHNvdXJjZUltYWdlLm5hdHVyYWxXaWR0aDtcbiAgICAgICAgaCA9IHNvdXJjZUltYWdlLm5hdHVyYWxIZWlnaHQ7XG5cbiAgICAgICAgaWYgKG9yaWVudGF0aW9uID09PSBET0NfT1JJRU5UQVRJT04uUmlnaHQgfHwgb3JpZW50YXRpb24gPT09IERPQ19PUklFTlRBVElPTi5MZWZ0KSB7XG4gICAgICAgICAgY29uc3QgdCA9IHc7XG4gICAgICAgICAgdyA9IGg7XG4gICAgICAgICAgaCA9IHQ7XG4gICAgICAgIH1cblxuICAgICAgICBjYW52YXMud2lkdGggPSB3ICogcmF0aW87XG4gICAgICAgIGNhbnZhcy5oZWlnaHQgPSBoICogcmF0aW87XG5cblxuICAgICAgICBjb25zdCBUT19SQURJQU5TID0gTWF0aC5QSSAvIDE4MDtcblxuICAgICAgICBpZiAob3JpZW50YXRpb24gPT09IERPQ19PUklFTlRBVElPTi5VcCkge1xuXG4gICAgICAgICAgY3R4LmRyYXdJbWFnZShzb3VyY2VJbWFnZSwgMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcblxuICAgICAgICB9IGVsc2UgaWYgKG9yaWVudGF0aW9uID09PSBET0NfT1JJRU5UQVRJT04uUmlnaHQpIHtcblxuICAgICAgICAgIGN0eC5zYXZlKCk7XG4gICAgICAgICAgY3R4LnJvdGF0ZSg5MCAqIFRPX1JBRElBTlMpO1xuICAgICAgICAgIGN0eC50cmFuc2xhdGUoMCwgLWNhbnZhcy53aWR0aCk7XG4gICAgICAgICAgY3R4LmRyYXdJbWFnZShzb3VyY2VJbWFnZSwgMCwgMCwgY2FudmFzLmhlaWdodCwgY2FudmFzLndpZHRoKTtcbiAgICAgICAgICBjdHgucmVzdG9yZSgpO1xuXG4gICAgICAgIH0gZWxzZSBpZiAob3JpZW50YXRpb24gPT09IERPQ19PUklFTlRBVElPTi5MZWZ0KSB7XG5cbiAgICAgICAgICBjdHguc2F2ZSgpO1xuICAgICAgICAgIGN0eC5yb3RhdGUoLTkwICogVE9fUkFESUFOUyk7XG4gICAgICAgICAgY3R4LnRyYW5zbGF0ZSgtY2FudmFzLndpZHRoLCAwKTtcbiAgICAgICAgICBjdHguZHJhd0ltYWdlKHNvdXJjZUltYWdlLCAwLCAwLCBjYW52YXMuaGVpZ2h0LCBjYW52YXMud2lkdGgpO1xuICAgICAgICAgIGN0eC5yZXN0b3JlKCk7XG5cbiAgICAgICAgfSBlbHNlIGlmIChvcmllbnRhdGlvbiA9PT0gRE9DX09SSUVOVEFUSU9OLkRvd24pIHtcblxuICAgICAgICAgIGN0eC5zYXZlKCk7XG4gICAgICAgICAgY3R4LnJvdGF0ZSgxODAgKiBUT19SQURJQU5TKTtcbiAgICAgICAgICBjdHgudHJhbnNsYXRlKC1jYW52YXMud2lkdGgsIC1jYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgICBjdHguZHJhd0ltYWdlKHNvdXJjZUltYWdlLCAwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpO1xuICAgICAgICAgIGN0eC5yZXN0b3JlKCk7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oJ25neC1pbWFnZS1jb21wcmVzcyAtIG5vIG9yaWVudGF0aW9uIHZhbHVlIGZvdW5kJyk7XG4gICAgICAgICAgLy8gc2FtZSBhcyBkZWZhdWx0IFVQXG4gICAgICAgICAgY3R4LmRyYXdJbWFnZShzb3VyY2VJbWFnZSwgMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgY29uc3QgbWltZSA9IGltYWdlRGF0YVVybFNvdXJjZS5zdWJzdHIoNSwgaW1hZ2VEYXRhVXJsU291cmNlLnNwbGl0KCc7JylbMF0ubGVuZ3RoIC0gNSk7XG4gICAgICAgIC8vIFRPRE8gdGVzdCBvbiBtaW1lXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGNhbnZhcy50b0RhdGFVUkwobWltZSwgcXVhbGl0eSk7XG5cbiAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuXG4gICAgICB9O1xuXG4gICAgICBzb3VyY2VJbWFnZS5zcmMgPSBpbWFnZURhdGFVcmxTb3VyY2U7XG5cbiAgICB9KTtcblxuICAgIHJldHVybiBwcm9taXNlO1xuICB9XG5cblxuICAvKipcbiAgICogaGVscGVyIHRvIGV2YWx1YXRlIHRoZSBjb21wcmVzc2lvbiByYXRlXG4gICAqIEBwYXJhbSBzIHRoZSBpbWFnZSBpbiBiYXNlNjQgc3RyaW5nIGZvcm1hdFxuICAgKi9cbiAgc3RhdGljIGJ5dGVDb3VudChzOiBzdHJpbmcpOiBudW1iZXIge1xuICAgIHJldHVybiBlbmNvZGVVUkkocykuc3BsaXQoLyUuLnwuLykubGVuZ3RoIC0gMTtcbiAgfVxuXG59XG4iXX0=